#!/usr/bin/python

import os, sys, imp
from astgen import astgen
from optparse import OptionParser

DEFAULT_BACKEND="cpp"

def parse_options():
    parser = OptionParser()
    parser.add_option("-o", "--outputfile", dest = "outputfile", metavar = "OUTPUTFILE",
                      help = "File to write the generated AST code to.  If this is not provided, then the output is written to standard output.  Also this can be a folder where package names are implied by file paths.")
    parser.add_option("-b", "--backend", dest = "backend", metavar = "BACKEND", default = DEFAULT_BACKEND,
                      help = "The backend to generate code for, eg cpp, java, python etc")
    parser.add_option("-t", "--templatepaths", dest = "template_paths", metavar = "TEMPLATE_PATHS", 
                      help = "Locations where backend specific templates are to be found.")
    parser.add_option("-i", "--inputfile", dest = "input_file", metavar = "INPUT_FILE", 
                      help = "Input file containing AST definitions for which AST code is to be generated.")
    (options, args) = parser.parse_args()
    if not options.input_file:
        parser.error("Input file parameter is mandatory")
    return options, args

if __name__ == "__main__":
    options, args = parse_options()

    the_module = imp.load_source("", options.input_file)
    nodeclasses = []
    for attrname in dir(the_module):
        try:
            attr = getattr(the_module, attrname)
            if attrname != "ASTNode" and any(map(lambda x: x.__name__ == "ASTNode", attr.__mro__)):
                print "Generating code for: ", attr, attrname, attr.getAllAttributes()
                nodeclasses.append(attr)
        except (TypeError, AttributeError):
            pass

    codegen = astgen.ASTCodeGen();
    codegen.generateCode(nodeclasses);
